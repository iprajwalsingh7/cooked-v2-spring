<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cooked V2 - The Ultimate Roast App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for parsing Markdown returned by Gemini -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }

        .roast-card {
            background-color: #161b22;
            border: 1px solid #30363d;
        }

        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
            color: #ffffff;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 16px;
        }

        .markdown-body p {
            margin-bottom: 16px;
        }

        .markdown-body ul,
        .markdown-body ol {
            padding-left: 2em;
            margin-bottom: 16px;
        }

        .markdown-body strong {
            color: #e6edf3;
            font-weight: 600;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="main-heading" class="max-w-xl w-full text-center mb-12 mt-8">
        <h1 class="text-[5rem] font-bold text-white mb-4 tracking-tighter leading-none">
            COOKED<span class="text-red-500">.</span>
        </h1>
        <p class="text-lg text-gray-400">The ultimate roasting platform. Select your victim and let us humble you.</p>
    </div>

    <!-- Roast Selection Hub -->
    <div id="hub-view" class="max-w-5xl w-full flex flex-col md:flex-row gap-6 px-4 justify-center items-stretch">

        <!-- Spotify Card -->
        <div class="flex-1 roast-card rounded-2xl p-8 flex flex-col items-center justify-center text-center hover:bg-[#111418] transition-all cursor-pointer group shadow-[0_0_15px_rgba(0,0,0,0.5)]"
            onclick="switchView('spotify-view')">
            <svg class="w-12 h-12 text-[#1DB954] mb-4 transition-transform group-hover:scale-110" fill="currentColor"
                viewBox="0 0 24 24">
                <path
                    d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.54.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.24 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.6.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
            </svg>
            <h2 class="text-xl font-bold text-white mb-3 tracking-tight">Spotify Roast</h2>
            <p class="text-sm text-gray-400 leading-relaxed">Judge your terrible music taste and obsession with sad
                songs.</p>
        </div>

        <!-- GitHub Card -->
        <div class="flex-1 roast-card rounded-2xl p-8 flex flex-col items-center justify-center text-center hover:bg-[#111418] transition-all cursor-pointer group shadow-[0_0_15px_rgba(0,0,0,0.5)]"
            onclick="switchView('github-view')">
            <svg class="w-12 h-12 text-white mb-4 transition-transform group-hover:scale-110" fill="currentColor"
                viewBox="0 0 24 24">
                <path fill-rule="evenodd"
                    d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                    clip-rule="evenodd"></path>
            </svg>
            <h2 class="text-xl font-bold text-white mb-3 tracking-tight">GitHub Roast</h2>
            <p class="text-sm text-gray-400 leading-relaxed">Expose your spaghetti code, empty repos, and lack of
                commits.</p>
        </div>

        <!-- Reddit Card -->
        <div class="flex-1 roast-card rounded-2xl p-8 flex flex-col items-center justify-center text-center hover:bg-[#111418] transition-all cursor-pointer group shadow-[0_0_15px_rgba(0,0,0,0.5)]"
            onclick="switchView('reddit-view')">
            <svg class="w-12 h-12 text-[#ff4500] mb-4 transition-transform group-hover:scale-110" fill="currentColor"
                viewBox="0 0 24 24">
                <path
                    d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z" />
            </svg>
            <h2 class="text-xl font-bold text-white mb-3 tracking-tight">Reddit Roast</h2>
            <p class="text-sm text-gray-400 leading-relaxed">Analyze your karma farming and cringe takes in echo
                chambers.</p>
        </div>
    </div>

    <!-- GitHub View -->
    <div id="github-view" class="max-w-2xl w-full hidden text-center px-4">
        <button onclick="switchView('hub-view')"
            class="text-gray-500 hover:text-white mb-6 flex items-center text-xs transition-colors font-bold tracking-widest uppercase">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18">
                </path>
            </svg>
            Back
        </button>
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 tracking-tight">Your Code is</h1>
        <h1
            class="text-[3.5rem] md:text-[5rem] font-bold text-white mb-6 drop-shadow-[0_0_15px_rgba(255,255,255,0.4)] tracking-tight leading-none">
            Cooked.</h1>
        <p class="text-gray-400 mb-10 max-w-md mx-auto text-base leading-relaxed">Spaghetti code? Endless forks? Zero
            commits?<br>Enter your username and let us expose your dev career.</p>

        <form id="github-form" class="max-w-[400px] mx-auto w-full space-y-4">
            <div class="relative">
                <input type="text" id="username" name="username" placeholder="GitHub Username" required
                    class="w-full bg-[#0d1014] border border-[#30363d] rounded-xl px-4 py-4 text-white placeholder-gray-600 focus:outline-none focus:border-white focus:ring-1 focus:ring-white transition-all shadow-inner font-mono text-sm">
            </div>

            <button type="submit" id="github-submit"
                class="w-full bg-[#1e4620] hover:bg-[#2ea043] text-[#cfebd6] hover:text-white font-bold tracking-wider py-4 px-4 rounded-full transition-colors flex items-center justify-center uppercase text-xs mt-4 shadow-lg">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
                <span>ROAST MY REPO</span>
            </button>
        </form>
    </div>

    <!-- Reddit View -->
    <div id="reddit-view" class="max-w-2xl w-full hidden text-center px-4">
        <button onclick="switchView('hub-view')"
            class="text-gray-500 hover:text-white mb-6 flex items-center text-xs transition-colors font-bold tracking-widest uppercase">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18">
                </path>
            </svg>
            Back
        </button>
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 tracking-tight">Your Opinions are</h1>
        <h1
            class="text-[3.5rem] md:text-[5rem] font-bold text-[#ff4500] mb-6 drop-shadow-[0_0_15px_rgba(255,69,0,0.4)] tracking-tight leading-none">
            Cooked.</h1>
        <p class="text-gray-400 mb-10 max-w-md mx-auto text-base leading-relaxed">Karma farming? Cringe edits? Echo
            chambers?<br>Enter your username and let us judge your internet existence.</p>

        <form id="reddit-form" class="max-w-[400px] mx-auto w-full space-y-4">
            <div class="relative">
                <input type="text" id="reddit-username" name="username" placeholder="Reddit Username (e.g. u/spez)"
                    required
                    class="w-full bg-[#0d1014] border border-[#ff4500]/30 rounded-xl px-4 py-4 text-white placeholder-gray-600 focus:outline-none focus:border-[#ff4500] focus:ring-1 focus:ring-[#ff4500] transition-all focus:shadow-[0_0_15px_rgba(255,69,0,0.15)] font-mono text-sm">
            </div>

            <button type="submit" id="reddit-submit"
                class="w-full bg-[#1e4620] hover:bg-[#2ea043] text-[#cfebd6] hover:text-white font-bold tracking-wider py-4 px-4 rounded-full transition-colors flex items-center justify-center uppercase text-xs mt-4 shadow-lg">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                    </path>
                </svg>
                <span>ROAST MY KARMA</span>
            </button>
        </form>
    </div>

    <!-- Spotify View -->
    <div id="spotify-view" class="max-w-2xl w-full hidden text-center px-4">
        <button onclick="switchView('hub-view')"
            class="text-gray-500 hover:text-white mb-6 flex items-center text-xs transition-colors font-bold tracking-widest uppercase">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18">
                </path>
            </svg>
            Back
        </button>
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 tracking-tight">Your Music Taste is</h1>
        <h1
            class="text-[3.5rem] md:text-[5rem] font-bold text-[#1DB954] mb-6 drop-shadow-[0_0_15px_rgba(29,185,84,0.3)] tracking-tight leading-none">
            Cooked.</h1>
        <p class="text-gray-400 mb-10 max-w-md mx-auto text-base leading-relaxed">Let's be honest, your Spotify history
            is a mess.<br>Connect your account and find out exactly how bad it is.</p>

        <div class="max-w-[400px] mx-auto w-full">
            <button id="spotify-login-btn" onclick="loginWithSpotify()"
                class="w-full bg-[#1DB954] hover:bg-[#1ed760] text-black font-bold tracking-wider py-4 px-4 rounded-full transition-colors flex items-center justify-center uppercase text-xs shadow-[0_0_20px_rgba(29,185,84,0.2)]">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.54.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.24 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.6.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                </svg>
                <span>CONNECT WITH SPOTIFY</span>
            </button>
            <p
                class="text-gray-500 text-[11px] mt-6 flex items-center justify-center cursor-pointer hover:text-gray-300 transition-colors">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg> Trouble connecting?
            </p>
        </div>
    </div>
    <!-- Shared Results Container -->
    <div id="shared-results" class="max-w-3xl mx-auto w-full hidden mt-12 px-4">
        <div class="roast-card rounded-2xl p-8 shadow-[0_0_20px_rgba(0,0,0,0.5)] border-[#30363d]">
            <!-- Loading State -->
            <div id="loading" class="hidden text-center">
                <svg class="animate-spin h-8 w-8 text-red-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <p class="text-sm text-gray-400 animate-pulse">Consulting the ultimate hater...</p>
            </div>

            <!-- Error State -->
            <div id="error-container"
                class="hidden bg-red-900/20 border border-red-500/50 rounded-lg p-4 text-red-200 text-sm"></div>

            <!-- Result State -->
            <div id="result-container" class="hidden">
                <div class="flex items-center justify-between mb-4 border-b border-[#30363d] pb-4">
                    <h3 class="text-lg font-semibold text-white">The Verdict</h3>
                    <button onclick="copyToClipboard()" class="text-gray-400 hover:text-white transition-colors"
                        title="Copy to clipboard">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                            </path>
                        </svg>
                    </button>
                </div>
                <div id="roast-content" class="markdown-body text-gray-300 text-sm leading-relaxed"></div>
            </div>
        </div>
    </div>

    <!-- Script for UI Logic -->
    <script>
        // Use marked options for safer rendering
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        const API_BASE = '/api/roast';
        let currentRawRoast = '';

        function switchView(viewId) {
            document.getElementById('main-heading').classList.add('hidden');
            document.getElementById('hub-view').classList.add('hidden');
            document.getElementById('github-view').classList.add('hidden');
            document.getElementById('reddit-view').classList.add('hidden');
            document.getElementById('spotify-view').classList.add('hidden');
            document.getElementById('shared-results').classList.add('hidden');

            document.getElementById(viewId).classList.remove('hidden');

            if (viewId === 'hub-view') {
                document.getElementById('main-heading').classList.remove('hidden');
            }

            // Reset states when switching
            hideAllStates();
            if (viewId === 'github-view') {
                document.getElementById('username').value = '';
            } else if (viewId === 'reddit-view') {
                document.getElementById('reddit-username').value = '';
            }
        }

        function hideAllStates() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-container').classList.add('hidden');
            document.getElementById('result-container').classList.add('hidden');
            document.getElementById('github-submit').disabled = false;
            document.getElementById('reddit-submit').disabled = false;
        }

        function showError(message) {
            document.getElementById('shared-results').classList.remove('hidden');
            const errorDiv = document.getElementById('error-container');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('github-submit').disabled = false;
            document.getElementById('reddit-submit').disabled = false;
        }

        async function copyToClipboard() {
            if (!currentRawRoast) return;
            try {
                await navigator.clipboard.writeText(currentRawRoast);
                // Simple visual feedback
                const btn = document.querySelector('button[title="Copy to clipboard"]');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                setTimeout(() => { btn.innerHTML = originalHTML; }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
        }

        async function handleFormSubmit(e, endpoint, inputId, submitBtnId) {
            e.preventDefault();

            const username = document.getElementById(inputId).value.trim();
            if (!username) return;

            // UI State updates
            hideAllStates();
            document.getElementById('shared-results').classList.remove('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById(submitBtnId).disabled = true;

            try {
                const response = await fetch(`${API_BASE}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `Server error: ${response.status}`);
                }

                // Render success
                document.getElementById('loading').classList.add('hidden');
                currentRawRoast = data.roast;
                document.getElementById('roast-content').innerHTML = marked.parse(data.roast);
                document.getElementById('result-container').classList.remove('hidden');

            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById(submitBtnId).disabled = false;
            }
        }

        document.getElementById('github-form').addEventListener('submit', (e) => handleFormSubmit(e, 'github', 'username', 'github-submit'));
        document.getElementById('reddit-form').addEventListener('submit', (e) => handleFormSubmit(e, 'reddit', 'reddit-username', 'reddit-submit'));

        // Spotify OAuth Flow
        function loginWithSpotify() {
            // Ensure this is loaded dynamically depending on your environment
            const clientId = 'efa0b315ed74450896c036ff6933ee5a';

            // For production deployments, fallback to origin. For local development, use 127.0.0.1
            const origin = window.location.origin;
            const redirectUri = origin.includes('localhost') || origin.includes('127.0.0.1') ? 'http://127.0.0.1:8080/' : origin + '/';

            // Spotify OAuth scopes
            const scopes = 'user-read-recently-played user-top-read';

            const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}`;
            window.location.href = authUrl;
        }

        async function processSpotifyCallback(code) {
            switchView('spotify-view');
            hideAllStates();
            document.getElementById('shared-results').classList.remove('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('spotify-login-btn').disabled = true;

            try {
                const response = await fetch(`${API_BASE}/spotify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `Server error: ${response.status}`);
                }

                // Render success
                document.getElementById('loading').classList.add('hidden');
                currentRawRoast = data.roast;
                document.getElementById('roast-content').innerHTML = marked.parse(data.roast);
                document.getElementById('result-container').classList.remove('hidden');

            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('spotify-login-btn').disabled = false;
            }
        }

        // On load, check if we're returning from Spotify Auth
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (code) {
                // clear URL
                window.history.replaceState({}, document.title, "/");
                processSpotifyCallback(code);
            } else if (error) {
                window.history.replaceState({}, document.title, "/");
                switchView('spotify-view');
                showError("Spotify Authentication Failed: " + error);
            }
        };
    </script>
</body>

</html>